var dataService=new function(){var e="/api/dataService/",t=function(t){return $.getJSON(e+"account/"+t)},o=function(){return $.getJSON(e+"marketIndices")},a=function(t){return $.getJSON(e+"quote/"+t)},i=function(){return $.getJSON(e+"tickerQuotes")};return{getAccount:t,getMarketIndexes:o,getQuote:a,getTickerQuotes:i}};Handlebars.registerHelper("getChangeCSSClass",function(e){var t=parseFloat(e);return t>0?"Positive":"Negative"}),Handlebars.registerHelper("addPlus",function(e){var t=parseFloat(e);return t>0?"+":""}),Handlebars.registerHelper("addPlusMinus",function(e){var t=parseFloat(e);return t>0?"+":"-"});var sceneLayoutService=function(){var e,t=function(){e=$("#content").width();var t=6,o=210,a=93,i=93,r=264,n=197,l=365,s=270,d=340,c=584,u={tiles:[{name:"Account Details",tileId:"AccountDetails",formatter:tileFormatter.formatAccountDetails,scenes:[{height:n,width:l,top:0,left:0,opacity:1,size:1,borderColor:"#5E1B6B",z:0},{height:90,width:210,top:80,left:250,size:0,borderColor:"#5E1B6B",z:"2000",opacity:.5}]},{name:"Video",tileId:"Video",formatter:tileFormatter.formatVideo,scenes:[{height:n,width:s,top:0,left:l+t,opacity:1,size:1,borderColor:"#EF7632",z:0},{height:200,width:280,top:0,left:500,size:1,borderColor:"#EF7632",z:"10000",opacity:1}]},{name:"DOW",tileId:"DOW",formatter:tileFormatter.formatMarketData,chartColor:"green",scenes:[{height:a,width:r,top:0,left:l+s+2*t,opacity:1,size:0,borderColor:"#CE0810",z:0},{height:90,width:200,top:60,left:870,size:0,borderColor:"#CE0810",opacity:.7}]},{name:"NASDAQ",tileId:"NASDAQ",formatter:tileFormatter.formatMarketData,chartColor:"red",scenes:[{height:i,width:r,top:a+1.8*t,left:l+s+2*t,opacity:1,size:0,borderColor:"#CE0810",z:0},{height:105,width:250,top:200,left:0,size:0,borderColor:"#CE0810",opacity:.65,z:"2000"}]},{name:"SP500",tileId:"SP500",formatter:tileFormatter.formatMarketData,chartColor:null,scenes:[{height:a,width:r,top:0,left:l+s+r+3*t,opacity:1,size:0,borderColor:"#CE0810",z:0},{height:100,width:260,top:430,left:525,size:0,opacity:.45,z:"1000",borderColor:"#00324B"}]},{name:"Sector Summary",tileId:"SectorSummary",scenes:[{height:i,width:r,top:a+1.8*t,left:l+s+r+3*t,opacity:1,size:0,borderColor:"#00A600",z:0},{height:155,width:280,top:220,left:620,size:0,borderColor:"#00A600",opacity:.65}]},{name:"Market News",tileId:"MarketNews",scenes:[{height:n,width:l,top:0,left:l+s+2*r+4*t,opacity:1,size:1,borderColor:"#3749A9",z:0},{height:225,width:350,top:270,left:850,size:0,borderColor:"#3749A9",opacity:.9}]},{name:"Currencies",tileId:"Currencies",scenes:[{height:n,width:s,top:0,left:2*l+s+2*r+5*t,opacity:1,size:1,borderColor:"#00F277",z:0},{height:140,width:220,top:370,left:115,size:0,borderColor:"#00F277",opacity:.35}]},{name:"Quotes",tileId:"Quote",formatter:tileFormatter.formatQuote,scenes:[{height:d,width:c,top:o,left:0,opacity:1,size:2,borderColor:"#00324B",z:0},{height:205,width:270,top:240,left:305,size:1,borderColor:"#CE0810",opacity:.85,z:"5000"}]},{name:"Account Positions",tileId:"AccountPositions",formatter:tileFormatter.formatAccountPositions,scenes:[{height:d,width:c,top:o,left:592,opacity:1,size:2,borderColor:"#5DBBC0",z:0},{height:90,width:195,top:40,left:58,size:0,borderColor:"#5DBBC0",opacity:.2,z:"100"}]}]};return u};return{get:t}}(),sceneStateManager=function(){var e,t,o=1,a=760,i=!0,r=function(o){e=o;var a=sceneLayoutService.get();t=a.tiles,n(),tileBinder.loadTemplate("QuoteDataTemplate"),l(),d(),s()},n=function(){$(window).focus(function(){i=!0}),$(window).blur(function(){i=!1}),$("#left").click(C),$("#right").click(g),$("#gridButton").click(function(){y()}),$("#cloudButton").click(function(){y()})},l=function(){$(t).each(function(e){var t=$("<div/>",{class:"tile",text:this.name,id:this.tileId});t.data(this),b(t,this.scenes[o]),t.appendTo("#content"),e<8&&t.addClass("top-row"),t.draggable({opacity:.9,zIndex:5e3,revert:"invalid",revertDuration:500}),t.droppable({tolerance:"pointer",drop:function(e,t){v(t.draggable,$(this))}})})},s=function(){setTimeout(function(){dataService.getTickerQuotes().done(m),$("#aaglogo").delay("500").fadeIn("slow"),$(".tile").each(function(){$(this).fadeIn(360,"easeInCubic",function(){"Quote"===$(this).attr("id")&&$("#QuoteButton").click()})})},1e3),setInterval(function(){i&&dataService.getMarketIndexes().done(f)},15e3);var e=setInterval(function(){$("#AccountDetails").data().templates&&$("#AccountPositions").data().templates&&(clearInterval(e),y(),$(".scroller").delay(1e3).each(function(){$(this).fadeIn("slow","easeInCubic")}))},2e3)},d=function(){dataService.getAccount(e).done(p),dataService.getMarketIndexes().done(f),h()},c=function(e,t,o){return o>0&&t.fadeOut(o),o>0?void u(e,t,o):void tileBinder.bind(t,e,tileRenderer.render)},u=function(e,t,o){t.fadeIn(o,function(){tileBinder.bind(t,e,tileRenderer.render)})},h=function(){$("#Video, #Quote, #SectorSummary, #MarketNews, #Currencies").each(function(){if(!$(this).data().templates){var e=$(this);tileBinder.bind(e,null,tileRenderer.render)}})},f=function(e){c(e,$("#DOW"),1200),c(e,$("#NASDAQ"),800),c(e,$("#SP500"),500)},p=function(e){$('div.tile[id^="Account"]').each(function(){c(e,$(this),500)})},m=function(e){$("#content").delay("800").fadeIn("slow"),$("#ticker").delay("2360").fadeIn("slow","easeInCubic",function(){$("#MarqueeNewsText").append(tileBinder.tmpl("TickerTemplate_News",e)),$("#MarqueeQuotesText").append(tileBinder.tmpl("TickerTemplate_Quotes",e));var t={velocity:50,direction:"horizontal",startfrom:"right",loop:"infinite",movetype:"linear",onmouseover:"play",onmouseout:"play",onstartup:"play",cursor:"pointer"};$("#MarqueeNews").SetScroller(t),$("#MarqueeQuotes").SetScroller(t)})},v=function(e,t){var a=e.data().scenes[o],i=t.data().scenes[o];if(b(t,a),b(e,i),w(a,i),0===o){var r=e.hasClass("top-row"),n=t.hasClass("top-row");r&&!n?(e.removeClass("top-row"),t.addClass("top-row")):!r&&n&&(t.removeClass("top-row"),e.addClass("top-row"))}var l=a.size,s=i.size;l!=s&&(t.data().scenes[o].size=l,e.data().scenes[o].size=s,tileRenderer.render(t),tileRenderer.render(e))},g=function(){$(".top-row").animate({left:"-=250px"},800,function(){$(this).data().scenes[o].left-=250})},C=function(){$(".top-row").animate({left:"+=250px"},800,function(){$(this).data().scenes[o].left+=250})},y=function(){0===o?(o=1,$(".scroller").hide(),$("#gridButton").delay(Math.floor(450*Math.random())).attr("disabled",!1).addClass("enabled"),$("#cloudButton").delay(Math.floor(450*Math.random())).attr("disabled",!0).removeClass("enabled")):1===o&&(o=0,$(".scroller").show(),$("#cloudButton").attr("disabled",!1).addClass("enabled"),$("#gridButton").attr("disabled",!0).removeClass("enabled")),$(".tile").each(function(){var e=$(this);b(e,e.data().scenes[o]),tileRenderer.render(e,o)})},b=function(e,t){e.animate({opacity:t.opacity,top:t.top,left:t.left,height:t.height,width:t.width,zIndex:t.z},{duration:a,easing:"easeInOutExpo",step:function(){},complete:function(){}})},w=function(e,t){var o=e.top,a=e.left,i=e.height,r=e.width,n=e.opacity,l=e.zindex;e.top=t.top,e.left=t.left,e.height=t.height,e.width=t.width,e.opacity=t.opacity,e.zindex=t.zindex,t.top=o,t.left=a,t.height=i,t.width=r,t.opacity=n,t.zindex=l};return{init:r}}(),tileBinder=function(){var e="/Templates/",t=function(e,t,i){var r=e.attr("id")+"Template";o(r,function(o){var n=[a(r+"_Small",t),a(r+"_Medium",t),a(r+"_Large",t)];e.data().templates=n,e.data().tileData=t,i(e)})},o=function(t,o){$.get(e+t+".html",function(e){$("body").append(e);var a=t+"_Partial",i=$("#"+a);i.length&&Handlebars.registerPartial(a,i.html()),o&&o(e)})},a=function(e,t){var o=$("#"+e).html();if(t){var a=Handlebars.compile(o);return a(t)}return o};return{bind:t,loadTemplate:o,tmpl:a}}(),tileFormatter=new function(){var e=null,t=Raphael.ninja(),o=function(e){var t=e.data().scenes[0],o=$("#VideoPlayer"),a=2.43,i=Math.round(.75*t.height),r=Math.round(i*a);r>t.width&&(r=t.width-20),o.css({height:i+"px",width:r+"px"}),o.bind("click mousedown mouseup mousemove mouseenter mouseleave",function(e){e.stopPropagation()})},a=function(){var e=$("#QuoteButton"),t=$("#QuoteTextBox"),o=$("#Quote"),a=o.data().symbol;null!=a?t.val(a):t.val("msft");var i=function(){var e=t.val();""!=e&&dataService.getQuote(e).done(tileFormatter.formatQuoteData),o.data().symbol=t.val()};e.click(function(){i()}),t.keyup(function(e){13===e.keyCode&&i()}),e.is(":visible")&&e.trigger("click")},i=function(e){var t=["Small","Medium","Large"],o=$("#Quote"),a=$("#QuoteDataContainer");a.html("");var i=tileBinder.tmpl("QuoteDataTemplate_"+t[o.data().scenes[0].size],e);a.append(i);var r=$("#QuoteCanvas");if(r.length>0){r.html("");var l=.95*o.data().scenes[0].width,s=.52*o.data().scenes[0].height;n(r,l,s,"#6699FF",e,e.dataPoints)}o.find(".Currency").formatCurrency({symbol:""})},r=function(e){var t=e.attr("id"),o=t.indexOf("500")>-1?"sP500":t.toLowerCase(),a=$("#"+t+"Canvas");if(a.length>0){a.html("");var i=e.data().scenes[0].size,r=1===i?.55:.72,l=.94*e.data().scenes[0].width,s=e.data().scenes[0].height*r,d=e.data().tileData;n(a,l,s,e.data().chartColor,d[o],d[o+"DataPoints"])}e.find(".Currency").formatCurrency({symbol:""}),$("div.MarketQuoteLast").formatCurrency({symbol:""})},n=function(t,o,a,i,r,n){if(null!=n&&n.length>0){var s=[];for(var d in n){var c=n[d];s.push([c.jsTicks,c.value])}var u=r.last+.3*r.last,h={series:{lines:{show:!0,fill:!0},points:{show:!0,radius:5}},grid:{hoverable:!0,autoHighlight:!0},legend:{position:"se"},yaxis:{max:u,min:0},xaxis:{minTickSize:[1,"hour"],mode:"time",timeformat:"%h %P",twelveHourClock:!0}};t.attr("style","width:"+o+"px;height:"+a+"px;"),$.plot(t,[{color:i,shadowSize:4,label:"Simulated Data",data:s}],h),t.bind("plothover",function(t,o,a){if(a){if(e!=a.datapoint){e=a.datapoint,$("#CanvasTooltip").remove();var i=a.datapoint[1].toFixed(2);l(a.pageX,a.pageY,i)}}else $("#CanvasTooltip").remove(),e=null})}},l=function(e,t,o){$('<div id="CanvasTooltip">'+o+"</div>").css({position:"absolute",display:"none",top:t+5,left:e+15,border:"1px solid #000",padding:"2px","background-color":"#fee",opacity:.8}).appendTo("body").fadeIn(200)},s=function(e){e.find(".Currency").formatCurrency();var o=e.data().scenes[0];if($("#AccountPositionsSVG").length>0){var a=[],i=[];$(e.data().tileData.positions).each(function(){i.push(this.security.symbol+"\r\n"+this.shares+" shares"),a.push(this.shares)}),t("AccountPositionsSVG",500,420).pieChart(o.width/2,o.height/4+10,66,a,i,"#fff")}},d=function(e){e.find(".Currency").formatCurrency({roundToDecimalPlace:0});var t=$("#"+e.attr("id")+"Table");t.length>0&&t.DataTable({bPaginate:!1,bLengthChange:!1,bFilter:!1,bInfo:!1,bRetrieve:!0,aoColumns:[null,null,null,null,null,null,{sType:"currency"}]})};return{formatVideo:o,formatAccountDetails:s,formatAccountPositions:d,formatQuote:a,formatQuoteData:i,formatMarketData:r}},tileRenderer=function(){var e=function(e,t){var o=e.data();if(o.templates){t||(t=0);var a=o.scenes[t].size,i=o.formatter;e.html(o.templates[a]),null!=i&&i(e)}};return{render:e}}();